<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聲息之間 | Between Life and Breath</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. 全域變數與字體 --- */
        :root {
            --font-main: 'Noto Serif TC', serif;
            --font-eng: 'Cinzel', serif;
            --sidebar-width: 320px;
            --sidebar-trans-curve: cubic-bezier(0.25, 0.8, 0.25, 1); /* 絲滑物理曲線 */
            --sidebar-duration: 0.8s;
        }

        body {
            font-family: var(--font-main);
            background-color: #0a0a0c;
            color: #e0e0e0;
            overflow: hidden;
            margin: 0;
        }

        /* --- 2. 背景流動光暈 (Ambient Light) --- */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            /* 預設背景，JS 會動態修改這裡 */
            background: radial-gradient(circle at 50% 50%, #1a1a20, #000);
            z-index: -1;
            transition: background 2s ease-in-out; /* 顏色切換時的柔和過渡 */
        }

        /* --- 3. 絲滑側邊欄 (Off-Canvas) --- */
        .sidebar-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            z-index: 50;
            transform: translateX(0); /* 預設展開 */
            transition: transform var(--sidebar-duration) var(--sidebar-trans-curve);
        }

        /* 收起狀態 */
        .sidebar-wrapper.collapsed {
            transform: translateX(-100%);
        }

        .control-panel {
            width: 100%;
            height: 100%;
            /* 毛玻璃質感 */
            backdrop-filter: blur(40px) saturate(160%);
            background: linear-gradient(135deg, rgba(20, 20, 25, 0.9), rgba(20, 20, 25, 0.7));
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 20px 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 防止內容溢出 */
        }

        .panel-content {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            /* 隱藏 Scrollbar 但保留功能 */
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.2) transparent;
        }

        /* 側邊欄開關按鈕 (黏在側邊欄右側) */
        .toggle-btn {
            position: absolute;
            top: 50%;
            right: -32px;
            width: 32px;
            height: 64px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: none;
            border-radius: 0 4px 4px 0;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-eng);
            transition: all 0.3s ease;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            z-index: 60;
        }
        .toggle-btn:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }

        /* --- 4. 影片智慧置中 --- */
        #videoArea {
            position: absolute;
            top: 50%;
            /* 核心邏輯：預設在 (50% + 半個側邊欄寬) 的位置 */
            left: calc(50% + (var(--sidebar-width) / 2));
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: left var(--sidebar-duration) var(--sidebar-trans-curve);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 當 body 有 sidebar-closed 類別時，影片回到正中央 */
        body.sidebar-closed #videoArea {
            left: 50%;
        }

        .main-video {
            width: 65vw;
            aspect-ratio: 16/9;
            max-width: 900px;
            background: #000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: all 0.5s ease;
        }

        /* 影片呼吸光暈 */
        .video-glow-wrapper {
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            z-index: -1;
            filter: blur(25px);
            opacity: 0.5;
            transition: background 1.5s ease, opacity 1.5s ease;
        }

        /* --- 5. UI 元件美化 (標題、按鈕、進度條) --- */
        h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 0.2em;
            text-shadow: 0 0 15px rgba(255,255,255,0.3);
            margin-bottom: 0.5rem;
        }

        /* 藝術按鈕通用樣式 */
        .art-btn, .action-btn {
            font-family: var(--font-main);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.03);
            color: #ddd;
            padding: 10px 0;
            width: 100%;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            letter-spacing: 0.1em;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        .art-btn:hover:not(:disabled), .action-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.6);
            color: #fff;
            text-shadow: 0 0 8px rgba(255,255,255,0.8);
            box-shadow: 0 0 20px rgba(255,255,255,0.05);
        }
        .art-btn:disabled, .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-style: dashed;
        }

        /* 模式切換按鈕 */
        .mode-switch-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }
        .mode-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            transition: all 0.3s;
            position: relative;
            padding-bottom: 5px;
        }
        .mode-btn.active {
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .mode-btn.active::after {
            content: '';
            position: absolute;
            bottom: -5px; left: 0; width: 100%; height: 1px;
            background: #fff;
            box-shadow: 0 0 10px #fff;
        }

        /* 輸入框 */
        input[type="file"] {
            font-size: 0.8rem;
            color: #aaa;
        }
        input[type="file"]::file-selector-button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        input[type="file"]::file-selector-button:hover { background: rgba(255,255,255,0.2); }

        /* 極簡情緒條 */
        .stat-item { margin-bottom: 0.8rem; }
        .stat-label {
            display: flex; justify-content: space-between;
            font-size: 0.75rem; color: #888; margin-bottom: 4px;
            font-family: var(--font-eng);
        }
        .stat-track {
            height: 2px; background: rgba(255,255,255,0.1); width: 100%; position: relative;
        }
        .stat-bar {
            height: 100%; background: #fff; box-shadow: 0 0 8px currentColor;
            transition: width 0.3s ease;
        }

        /* 淡入動畫 */
        .fade-in { animation: fadeIn 1s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body id="dynamicBody">

    <div class="ambient-light" id="ambientLight"></div>

    <div id="sidebar" class="sidebar-wrapper">
        <div class="control-panel">
            <div class="panel-content">
                
                <div class="text-center mb-8 fade-in">
                    <h1>聲息之間</h1>
                    <div style="font-family: var(--font-eng); font-size: 0.7rem; letter-spacing: 0.3em; opacity: 0.5;">
                        BETWEEN LIFE AND BREATH
                    </div>
                </div>

                <div id="inputControlsSection" class="fade-in" style="animation-delay: 0.2s;">
                    
                    <div class="mode-switch-group">
                        <button type="button" id="mode-upload" onclick="setInputMode('upload')" class="mode-btn active">映象上傳</button>
                        <button type="button" id="mode-camera" onclick="setInputMode('camera')" class="mode-btn">即時觀測</button>
                    </div>

                    <div id="uploadControls" class="mb-8">
                        <input type="file" id="videoInput" accept="video/mp4" class="w-full mb-4"/>
                        <button onclick="uploadVideo()" id="uploadBtn" class="art-btn">上傳影像檔案</button>
                    </div>

                    <div id="cameraHint" class="hidden text-xs text-gray-500 mb-6 text-center tracking-widest">
                    </div>

                    <div class="flex flex-col gap-4">
                        <button onclick="startPhase1()" id="phase1Btn" class="action-btn" disabled>PHASE I : 解析運算</button>
                        <button onclick="startPhase2()" id="phase2Btn" class="action-btn" disabled>PHASE II : 共鳴播放</button>
                        <button onclick="startCamera()" id="cameraStartBtn" class="action-btn hidden">啟動觀測</button>
                        <button onclick="stopCamera()" id="cameraStopBtn" class="action-btn hidden" style="border-color: rgba(255,100,100,0.3); color: #faa;">中斷連結</button>
                    </div>
                </div>

                <div id="phase1ProgressContainer" class="mb-8 hidden fade-in mt-6">
                    <div class="flex justify-between mb-2 text-xs text-gray-500">
                        <span>ANALYZING</span>
                        <span id="phase1ProgressLabel">0%</span>
                    </div>
                    <div class="w-full bg-white/10 h-[1px]">
                        <div id="phase1ProgressBar" class="bg-white h-full shadow-[0_0_5px_white]" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-6 hidden" id="stopBtnContainer">
                    <button onclick="stopProcessing()" id="stopBtn" class="action-btn" style="border-color: rgba(255,100,100,0.3); color: #faa;">停止運作</button>
                </div>

                <div class="mb-8 hidden fade-in" id="handControlContainer">
                    <button id="btnHandToggle" onclick="toggleHandControl()" 
                            class="art-btn" style="border-color: rgba(255, 215, 0, 0.3); color: #ffe;">
                        手勢共鳴：開啟
                    </button>
                </div>

                <div class="hidden fade-in flex-1" id="statsSection">
                    <div class="text-xs text-center text-gray-600 tracking-[0.3em] mb-4 border-t border-white/5 pt-4">
                        EMOTIONAL RESONANCE
                    </div>
                    <div id="stats-container" class="space-y-3">
                        </div>
                </div>

            </div>
        </div>

        <button class="toggle-btn" onclick="togglePanel()" id="toggleBtn">&lt;</button>
    </div>

    <div id="videoArea">
        <div class="relative">
            <div class="video-glow-wrapper" id="videoGlow"></div>
            <div id="videoContainer" class="main-video">
                <p id="placeholderText" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600">
                    <span class="text-xl tracking-[0.2em] mb-2 font-light">靜待影像</span>
                    <span class="text-xs tracking-widest opacity-50 font-[Cinzel]">AWAITING SIGNAL</span>
                </p>
                <img id="processedFrame" class="w-full h-full object-contain hidden" />
            </div>
        </div>
    </div>

    <div id="pipContainer" class="fixed bottom-5 right-5 w-60 h-40 bg-black border border-white/20 hidden z-50">
        <img id="pipImage" class="w-full h-full object-cover opacity-80" />
    </div>

    <script>
        const socket = io();
        
        // 藝術感配色 (低飽和度)
        const emotionColors = {
            'Happy': 'rgb(255, 220, 100)',
            'Angry': 'rgb(255, 80, 80)',
            'Sad': 'rgb(100, 180, 255)',
            'Surprise': 'rgb(220, 150, 255)',
            'Fear': 'rgb(100, 80, 160)',
            'Disgust': 'rgb(100, 200, 120)',
            'Neutral': 'rgb(180, 180, 180)'
        };
        const emotions = ['Happy', 'Angry', 'Sad', 'Surprise', 'Fear', 'Disgust', 'Neutral'];

        // 狀態變數
        let isPanelCollapsed = false;
        let isProcessing = false;
        let inputMode = 'upload';
        let hasUploadedVideo = false;
        let isHandControlOn = true; 
        let isPhase1Completed = false;

        window.addEventListener('load', () => {
            setInputMode('upload');
            initStats();
            updateHandControlButtonUI();
        });

        // ---------------------------------------------
        // 1. 絲滑側邊欄切換
        // ---------------------------------------------
        function togglePanel() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleBtn');
            const body = document.body;

            const isCollapsed = sidebar.classList.contains('collapsed');

            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                body.classList.remove('sidebar-closed'); 
                toggleBtn.innerHTML = '&lt;';
            } else {
                sidebar.classList.add('collapsed');
                body.classList.add('sidebar-closed'); 
                toggleBtn.innerHTML = '&gt;';
            }
        }

        // ---------------------------------------------
        // 2. 背景變色 (保留混合邏輯)
        // ---------------------------------------------
        function getRgbValues(colorStr) {
            const match = colorStr.match(/\d+/g);
            return match ? match.map(Number) : [0, 0, 0];
        }

        function updateDynamicBackground(emotionData) {
            const significantEmotions = [];
            for (const [emotion, percentage] of Object.entries(emotionData)) {
                if (percentage > 5) significantEmotions.push({ emotion, percentage });
            }
            significantEmotions.sort((a, b) => b.percentage - a.percentage);

            const ambient = document.getElementById('ambientLight');
            const videoGlow = document.getElementById('videoGlow');

            if (significantEmotions.length === 0) {
                ambient.style.background = 'radial-gradient(circle at 50% 50%, #1a1a20, #000)';
                if(videoGlow) videoGlow.style.opacity = 0;
                return;
            }

            let gradientCSS = '';
            const topEmo = significantEmotions[0];
            const [r1, g1, b1] = getRgbValues(emotionColors[topEmo.emotion]);
            const op1 = Math.min(topEmo.percentage / 100 * 0.8, 0.6); 

            if (significantEmotions.length === 1) {
                gradientCSS = `radial-gradient(circle at 50% 50%, rgba(${r1}, ${g1}, ${b1}, ${op1}), transparent 70%)`;
            } else {
                const secondEmo = significantEmotions[1];
                const [r2, g2, b2] = getRgbValues(emotionColors[secondEmo.emotion]);
                const op2 = Math.min(secondEmo.percentage / 100 * 0.8, 0.5);

                if (significantEmotions.length >= 3) {
                    const thirdEmo = significantEmotions[2];
                    const [r3, g3, b3] = getRgbValues(emotionColors[thirdEmo.emotion]);
                    const op3 = Math.min(thirdEmo.percentage / 100 * 0.8, 0.4);
                    gradientCSS = `linear-gradient(135deg, rgba(${r1}, ${g1}, ${b1}, ${op1}) 0%, rgba(${r2}, ${g2}, ${b2}, ${op2}) 40%, rgba(${r3}, ${g3}, ${b3}, ${op3}) 70%, #000 100%)`;
                } else {
                    gradientCSS = `linear-gradient(135deg, rgba(${r1}, ${g1}, ${b1}, ${op1}) 10%, rgba(${r2}, ${g2}, ${b2}, ${op2}) 60%, #000 100%)`;
                }
            }
            ambient.style.background = gradientCSS;

            // 更新影片光暈
            if (videoGlow) {
                videoGlow.style.background = `linear-gradient(45deg, rgb(${r1},${g1},${b1}), #111, rgb(${r1},${g1},${b1}))`;
                videoGlow.style.opacity = Math.min(topEmo.percentage / 100 * 0.8 + 0.2, 0.8);
            }
        }

        // ---------------------------------------------
        // 3. 藝術感進度條 HTML
        // ---------------------------------------------
        function initStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '';
            emotions.forEach(emo => {
                const color = emotionColors[emo];
                const html = `
                    <div class="stat-item group">
                        <div class="stat-label">
                            <span class="group-hover:text-white transition-colors">${emo}</span>
                            <span id="val-${emo}" class="font-mono">0%</span>
                        </div>
                        <div class="stat-track">
                            <div id="bar-${emo}" class="stat-bar" style="width: 0%; background-color: ${color}; box-shadow: 0 0 10px ${color};"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // ---------------------------------------------
        // 4. 功能函式 (邏輯保持不變，只更新 Class)
        // ---------------------------------------------
        function setInputMode(mode) {
            if (isProcessing) { alert('系統運作中，請勿切換。'); return; }
            inputMode = mode;

            // 更新按鈕樣式
            const btnUpload = document.getElementById('mode-upload');
            const btnCamera = document.getElementById('mode-camera');
            if (mode === 'upload') {
                btnUpload.classList.add('active');
                btnCamera.classList.remove('active');
            } else {
                btnCamera.classList.add('active');
                btnUpload.classList.remove('active');
            }

            // 顯示/隱藏區塊
            const uploadControls = document.getElementById('uploadControls');
            const cameraHint = document.getElementById('cameraHint');
            const phase1Btn = document.getElementById('phase1Btn');
            const phase2Btn = document.getElementById('phase2Btn');
            const cameraStartBtn = document.getElementById('cameraStartBtn');
            const cameraStopBtn = document.getElementById('cameraStopBtn');

            document.getElementById('handControlContainer').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');

            if (mode === 'upload') {
                uploadControls.classList.remove('hidden');
                cameraHint.classList.add('hidden');
                phase1Btn.classList.remove('hidden');
                phase2Btn.classList.remove('hidden');
                phase1Btn.disabled = !hasUploadedVideo;
                phase2Btn.disabled = !isPhase1Completed;
                cameraStartBtn.classList.add('hidden');
                cameraStopBtn.classList.add('hidden');
                document.getElementById('processedFrame').classList.add('hidden');
                document.getElementById('placeholderText').style.display = 'flex';
            } else if (mode === "camera") {
                uploadControls.classList.add("hidden");
                cameraHint.classList.remove("hidden");
                phase1Btn.classList.add('hidden');
                phase2Btn.classList.add('hidden');
                cameraStartBtn.classList.remove("hidden");
                cameraStopBtn.classList.remove("hidden");
                const img = document.getElementById("processedFrame");
                const placeholder = document.getElementById("placeholderText");
                placeholder.style.display = "none";
                img.classList.remove("hidden");
                img.style.display = "block";
                document.getElementById('pipContainer').classList.add('hidden');
            }
        }

        function toggleHandControl() {
            isHandControlOn = !isHandControlOn;
            updateHandControlButtonUI();
            socket.emit('toggle_hand_control', { enabled: isHandControlOn });
            if (!isHandControlOn) {
                const videoContainer = document.getElementById('videoContainer');
                if(videoContainer) videoContainer.style.transform = "perspective(1000px) scale(1) rotateY(0deg)";
            }
        }

        function updateHandControlButtonUI() {
            const btn = document.getElementById('btnHandToggle');
            if (isHandControlOn) {
                btn.textContent = "手勢共鳴：開啟";
                btn.style.borderColor = "rgba(255, 215, 0, 0.5)";
                btn.style.color = "#ffeb3b";
            } else {
                btn.textContent = "手勢共鳴：關閉";
                btn.style.borderColor = "rgba(255, 255, 255, 0.1)";
                btn.style.color = "#666";
            }
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('videoInput');
            const file = fileInput.files[0];
            if (!file) return alert("請先選擇影像檔案");
            const formData = new FormData();
            formData.append('file', file);
            const btn = document.getElementById('uploadBtn');
            btn.textContent = "上傳中...";
            isProcessing = false;
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                if (res.ok) {
                    hasUploadedVideo = true;
                    isPhase1Completed = false;
                    setInputMode('upload'); 
                    btn.textContent = "上傳完成";
                    setTimeout(() => btn.textContent = "上傳影像檔案", 2000);
                } else {
                    alert("上傳失敗");
                    btn.textContent = "上傳影像檔案";
                }
            } catch (e) { console.error(e); btn.textContent = "上傳影像檔案"; }
        }

        function startPhase1() {
            if (isProcessing) return alert("系統運作中...");
            if (!hasUploadedVideo) return alert("請先上傳影像");
            isProcessing = true;
            initStats();
            document.getElementById('phase1ProgressContainer').classList.remove('hidden');
            resetPhase1Progress();
            
            document.getElementById('inputControlsSection').classList.add('hidden');
            document.getElementById('stopBtnContainer').classList.remove('hidden'); // 改用 remove hidden
            document.getElementById('stopBtnContainer').style.display = ''; // 清除可能殘留的 inline style
            
            document.getElementById('phase1Btn').disabled = true;
            document.getElementById('phase2Btn').disabled = true;
            socket.emit('start_phase1', { mode: inputMode });
        }

        function startPhase2() {
            if (isProcessing) return alert("系統運作中...");
            if (!hasUploadedVideo) return alert("請先完成 Phase I");
            isProcessing = true;
            initStats();
            
            document.getElementById('inputControlsSection').classList.add('hidden');
            document.getElementById('stopBtnContainer').classList.remove('hidden'); // 改用 remove hidden
            document.getElementById('stopBtnContainer').style.display = ''; 
            
            document.getElementById('processedFrame').classList.remove('hidden');
            document.getElementById('placeholderText').style.display = 'none';
            document.getElementById('handControlContainer').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            socket.emit('start_phase2', { mode: inputMode });
        }

        function startCamera(){
            if(isProcessing) return;
            isProcessing = true;
            document.getElementById("placeholderText").style.display="none";
            const img=document.getElementById("processedFrame");
            img.classList.remove("hidden");
            img.style.display="block";
            initStats();
            document.getElementById('handControlContainer').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            
            // [補充] 確保 Camera 模式下如果要顯示停止按鈕 (視你的設計而定，原本 Camera 是用側邊欄按鈕停)
            // 但為了保險，這裡也可以確保邏輯一致，不過原本設計 Camera 是在 inputControlsSection 裡面有停止鍵
            // 所以這裡維持原樣即可，或者如果你想統一用下方的大停止鍵，也可以照上面修改。
            // 根據你的 UI，Camera 模式有專屬的 "中斷連結" 按鈕在上面，所以這裡可以不用動 stopBtnContainer
            
            socket.emit("start_camera");
        }

        function stopCamera() { socket.emit('stop_camera'); }

        function stopProcessing() {
            if (!isProcessing) return;
            socket.emit('stop_processing');
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = true;
            stopBtn.textContent = '終止程序...';
        }

        // --- Socket Listeners ---
        socket.on('emotion_update', (data) => {
            for (const [key, value] of Object.entries(data)) {
                const bar = document.getElementById(`bar-${key}`);
                const val = document.getElementById(`val-${key}`);
                if (bar && val) {
                    bar.style.width = `${value}%`;
                    val.innerText = `${value.toFixed(1)}%`;
                }
            }
            updateDynamicBackground(data);
        });

        socket.on("video_frame", (data) => {
            if (!isProcessing) return;
            const img = document.getElementById("processedFrame");
            img.src = "data:image/jpeg;base64," + data.image;
        });

        socket.on('phase1_progress', (data) => {
            const bar = document.getElementById('phase1ProgressBar');
            const label = document.getElementById('phase1ProgressLabel');
            if (!bar || !label) return;
            const p = Math.max(0, Math.min(100, data.progress || 0));
            bar.style.width = p + '%';
            label.textContent = p.toFixed(0) + '%';
        });

        socket.on('processing_complete', (data) => {
            isProcessing = false;
            
            // [修正] 隱藏停止按鈕，顯示控制區
            document.getElementById('stopBtnContainer').classList.add('hidden'); // 加回 hidden
            document.getElementById('inputControlsSection').classList.remove('hidden');
            
            // 重置按鈕文字
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = false;
            stopBtn.textContent = '停止運作';

            if (data?.mode === 'phase1') {
                isPhase1Completed = true;
                setTimeout(() => { document.getElementById('phase1ProgressContainer').classList.add('hidden'); }, 1000);
            }
            setInputMode(inputMode);
            document.getElementById('pipContainer').classList.add('hidden');
            console.log(data?.msg || "Process Complete");
        });

        socket.on('interaction_update', (data) => {
            const videoContainer = document.getElementById('videoContainer');
            if (videoContainer) {
                videoContainer.style.transform = `perspective(1000px) scale(${data.scale}) rotateY(${data.rotate}deg)`;
            }
        });

        socket.on('camera_frame', (data) => {
            const pipContainer = document.getElementById('pipContainer');
            const pipImage = document.getElementById('pipImage');
            if (inputMode !== 'camera') {
                if(pipContainer.classList.contains('hidden')) pipContainer.classList.remove('hidden');
            } else {
                if(!pipContainer.classList.contains('hidden')) pipContainer.classList.add('hidden');
            }
            pipImage.src = "data:image/jpeg;base64," + data.image;
        });

        function resetPhase1Progress() {
            const bar = document.getElementById('phase1ProgressBar');
            const label = document.getElementById('phase1ProgressLabel');
            if (bar) bar.style.width = '0%';
            if (label) label.textContent = '0%';
        }
    </script>
</body>
</html>